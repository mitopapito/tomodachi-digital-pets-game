(()=>{"use strict";console.log("Tomodachi Pets Content Script Injected!");let e,t=null,n=null,s=null,o=!0,a=[],i=0;function l(){t&&a.length&&(i+=.01,a.forEach(((e,t)=>{const n=i+t/a.length*2*Math.PI;e.style.left=40*Math.cos(n)+"px",e.style.top=40*Math.sin(n)+"px"})),e=requestAnimationFrame(l))}function c(){t&&(t.remove(),t=null),e&&(cancelAnimationFrame(e),e=void 0),a=[]}function r(){if(c(),!n)return;const s=n,r=document.createElement("div");r.id="tomodachi-pet-container",r.style.position="fixed",r.style.zIndex="99999999",r.style.pointerEvents="none",r.style.transition="opacity 0.3s ease-in-out",r.style.opacity=o?"1":"0";let d=s.pet.imageUrl;if(!d&&s.assets.length,d){const e=document.createElement("img");e.src=d,e.alt=s.pet.name,e.style.width="50px",e.style.height="50px",e.style.objectFit="contain",e.style.position="absolute",e.style.transform="translate(-50%, -50%)",r.appendChild(e)}else{const e=document.createElement("div");e.textContent=s.pet.name,e.style.color="black",e.style.backgroundColor="rgba(255,255,255,0.7)",e.style.padding="2px 5px",e.style.borderRadius="3px",e.style.position="absolute",e.style.transform="translate(-50%, -50%)",r.appendChild(e)}a=[],s.assets&&s.assets.length>0&&s.assets.forEach((e=>{const t=document.createElement("img");t.src=e.url,t.alt=e.name,t.style.width="25px",t.style.height="25px",t.style.objectFit="contain",t.style.position="absolute",t.style.transition="left 0.2s linear, top 0.2s linear",t.style.transform="translate(-50%, -50%)",r.appendChild(t),a.push(t)})),document.body.appendChild(r),t=r,a.length>0&&(i=0,e&&cancelAnimationFrame(e),l())}function d(e){if(t&&o){const n=15,s=15;t.style.left=`${e.clientX+n}px`,t.style.top=`${e.clientY+s}px`}}function p(e,a){"local"===a&&e.petData&&(n=e.petData.newValue,o?r():!n&&t&&c()),"local"===a&&e.suiAddress&&(s=e.suiAddress.newValue,console.log("Content Script: Sui address updated from storage.",s),!n&&s&&chrome.runtime.sendMessage({type:"GET_PET_DATA"},(e=>{e&&"success"===e.status&&e.payload.petData&&(n=e.payload.petData,o&&r())})))}function u(){o=!o,t&&(t.style.opacity=o?"1":"0"),o&&!t&&n&&r(),chrome.storage.local.set({petCompanionVisible:o}),console.log("Pet companion visibility toggled: "+(o?"ON":"OFF"))}chrome.runtime.onMessage.addListener(((e,t,s)=>("PET_DATA_UPDATED"===e.type?(n=e.payload,console.log("Content Script: Received PET_DATA_UPDATED",n),o&&r(),s({status:"success"})):"PET_DATA_ERROR"===e.type?(console.error("Content Script: Received PET_DATA_ERROR",e.payload),n=null,c(),s({status:"error_received"})):"TOGGLE_VISIBILITY"===e.type&&(u(),s({status:"visibility_toggled",isVisible:o})),!0))),window.self===window.top?chrome.storage.local.get(["petData","suiAddress","petCompanionVisible"],(e=>{e.suiAddress&&(s=e.suiAddress),e.petData&&(n=e.petData),"boolean"==typeof e.petCompanionVisible&&(o=e.petCompanionVisible),n&&o?r():s&&!n&&(console.log("Content Script: Found address, no pet data. Requesting from background."),chrome.runtime.sendMessage({type:"GET_PET_DATA"},(e=>{e&&"success"===e.status&&e.payload.petData?(n=e.payload.petData,o&&r()):e&&"pending"===e.status&&console.log("Content Script: Pet data fetch is pending or address exists but no data yet.")}))),document.addEventListener("mousemove",d),chrome.storage.onChanged.addListener(p)})):console.log("Tomodachi Pets Content Script: Running in an iframe, aborting."),document.addEventListener("keydown",(e=>{e.ctrlKey&&e.shiftKey&&"P"===e.key&&(e.preventDefault(),u())}))})();